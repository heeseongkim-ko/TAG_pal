# Platform Tag - Current System Analysis

## 📋 Overview
Platform Tag is a UWB tag platform based on nRF52840, operating as a wireless tag system powered by battery.

## 🏗️ System Architecture

### Main Loop Structure
```
main() {
    // 1. System initialization
    // 2. Sequential execution of following functions in infinite loop:
    while(1) {
        Api_uwb_main();                    // UWB communication management
        nfc_read_example();                // NFC reader detection and data reading
        Api_Led_Main();                    // LED state management
        Api_battery_main();                // Battery management
        Aply_tag_manager_process();        // Main state machine (UWB lifecycle management)
        Api_sleep_main();                  // Sleep management
    }
}
```

## 🔄 Main State Machine (Aply_tag_manager)

### State Definitions
- **TAG_MANAGER_STATE_WAIT_UWB_INIT**: Wait for UWB initialization
- **TAG_MANAGER_STATE_NORMAL**: Normal operation mode
- **TAG_MANAGER_STATE_MOTION_SLEEP**: Motion sleep mode
- **TAG_MANAGER_STATE_NFC**: NFC processing mode

### State Transition Flow
```
WAIT_UWB_INIT → NORMAL → (MOTION_SLEEP/NFC) → NORMAL
```

### Detailed Operation
1. **TAG_MANAGER_STATE_WAIT_UWB_INIT**
   - Wait for UWB device to be ready
   - Generate MAC address and update packets
   - Transition to NORMAL state

2. **TAG_MANAGER_STATE_NORMAL**
   - Execute UWB TX and Sleep test process
   - Process LED control
   - Process battery check
   - Check readiness for sleep entry
   - Handle motion wakeup detection

3. **TAG_MANAGER_STATE_MOTION_SLEEP**
   - Motion sleep mode processing
   - Return to normal when motion detected or timer expired

4. **TAG_MANAGER_STATE_NFC**
   - NFC processing mode
   - Return to normal when NFC processing complete

## ⏰ Timer System

### 1. Base Timer (1ms)
- `APP_TIME_BASE = 1ms`
- Handled in `Timer_Counter()` function
- Calls timer tick for each module:
  - `Api_uwb_timer_tick()`
  - `Api_nfc_timer_tick()`
  - `Api_Led_Timer_tick()`
  - `Api_battery_timer_tick()`
  - `Aply_uwb_rx_timer_tick()`

### 2. 10ms/100ms Timer
- 10ms: `Timer_Counter_10msec()` (currently empty)
- 100ms: `Timer_Counter_100msec()` (currently empty)

### 3. RTC2 Timer
- Initialized by `Func_TIMER_Init()`
- Used for wakeup from sleep mode

## 📊 Counter System (Aply_tag_scheduler)

### Counter Types
1. **LED Counter** (`s_led_counter`)
   - Threshold: `LED_BLINK_INTERVAL_MS_DEFAULT`
   - Function: LED control trigger

2. **Battery Check Counter** (`s_battery_check_counter`)
   - Threshold: `ADC_MEASUREMENT_INTERVAL_MS_DEFAULT`
   - Function: Battery measurement trigger

3. **BC Packet Counter** (`s_normal_bc_packet_counter`)
   - Threshold: `CONFIG_FIELD_BC_PERIOD_RI`
   - Function: Backchannel packet transmission trigger

4. **Motion Sleep BC Counter** (`s_motion_sleep_bc_packet_counter`)
   - Threshold: `CONFIG_FIELD_BC_PERIOD_RISM`
   - Function: Backchannel packet in motion sleep mode

5. **Battery Packet Counter** (`s_bat_packet_counter`)
   - Threshold: `BATTERY_PACKET_INTERVAL_COUNT` (15)
   - Function: Battery packet transmission trigger

6. **Info Packet Counter** (`s_info_packet_counter`)
   - Threshold: `INFO_PACKET_INTERVAL_COUNT` (15)
   - Function: Info packet transmission trigger

7. **Start Info Packet Counter** (`s_start_info_packet_counter`)
   - Threshold: `START_INFO_PACKET_INTERVAL_COUNT_DEFAULT` (3)
   - Function: Send info packet 3 times at startup

8. **Motion Sleep Counter** (`s_motion_sleep_counter`)
   - Threshold: `CONFIG_FIELD_MOTION_SLEEP_TIME`
   - Function: Motion sleep trigger

### Counter Processing Logic
- Each counter decrements by 1
- When reaching 0, sets corresponding flag
- Flags are checked by other functions to perform actual operations

## 🔋 Battery Management

### LED Status Display
- **Green**: > 185 (3.65V) - Solid ON
- **Orange**: 178-185 (3.5V-3.65V) - Solid ON
- **Red**: < 178 (3.5V) - Blinking (10ms on/off)

### ADC Measurement
- Handled in `battery_check_process()` function
- Battery voltage measurement and LED status update

## 📡 UWB Communication

### Packet Types
1. **Blink Packet (BB)**: Basic position information packet
2. **Backchannel Packet (BC)**: Transmitted every 4th TX
3. **Battery Packet (BAT)**: Transmitted every 15th TX
4. **Info Packet (INFO)**: Transmitted every 15th TX (alternating with BAT)

### MAC Address Generation
- Generated by `Api_uwb_compose_MAC_address()`
- Stored in `g_mac_header` structure

### UWB State Machine
- **UWB_STATE_IDLE**: Waiting for sleep flag to be cleared
- **UWB_STATE_WAKEUP_START**: Start UWB device wakeup process
- **UWB_STATE_WAKEUP_WAIT**: Wait for wakeup process to complete
- **UWB_STATE_TX_WAIT**: Wait for transmission to complete
- **UWB_STATE_RX_START**: Start RX for BC response
- **UWB_STATE_RX_WAIT**: Wait for RX completion or timeout
- **UWB_STATE_SLEEP_START**: Start UWB device sleep process
- **UWB_STATE_SLEEP_WAIT**: Wait for sleep process to complete

## 🏃 Motion Detection

### Motion Detection Sensor
- Uses LIS2DH12 accelerometer
- Polling-based detection in `Aply_tag_scheduler_normal_process_cycle_complete()`

### Sleep Mode Wakeup
- Timer-based wakeup
- Motion detection-based wakeup (`check_motion_wakeup()`)

## 📱 NFC Functionality

### NFC Reader Detection
- NTAG I2C reader detection in `nfc_read_example()`
- Data reading when reader approaches
- Detection when reader is removed

### NFC Configuration Management
- `Aply_nfc_check_and_init_tag_configuration()`: Check NFC data and initialize tag configuration
- `Aply_nfc_write_default_config()`: Write default configuration to NFC EEPROM
- `Aply_nfc_read_all_config()`: Read all NFC configuration data
- MAC address comparison for configuration validation

## 🔧 Initialization Sequence

1. UART logging initialization
2. GPIO initialization (`Init_gpiote()`, `Func_TEIA_GPIO_Init()`)
3. ADC initialization (`Api_battery_init()`)
4. Timer initialization (`timers_init()`)
5. RTC2 initialization (`Func_TIMER_Init()`)
6. BLE initialization (`Api_ble_Init()`)
7. NFC initialization (`Api_nfc_init()`)
8. UWB system initialization (`Api_uwb_init_system()`)
9. UWB SPI initialization (`Api_uwb_spi_init()`)
10. UWB device initialization (`Api_uwb_init_device_blocking()`)
11. Motion detection initialization (`Func_Motion_Detection_Init()`)
12. MAC address generation and storage
13. Tag configuration initialization (`Aply_nfc_check_and_init_tag_configuration()`)
14. LED initialization (`Api_Led_Init()`)
15. Tag manager initialization (`Aply_tag_manager_init()`)
16. Tag scheduler initialization (`Aply_tag_scheduler_init()`)
17. UWB TX packet update (`Aply_uwb_tx_update_packets()`)
18. UART disable for power saving (`UART_LOG_UNINIT()`)

## 📁 Main File Structure

### Source/
- `main.c`: Main application and state machine

### Aply/
- `Aply_tag_manager.c/h`: Main tag manager and state machine
- `Aply_tag_scheduler.c/h`: Packet scheduling and counter management
- `Aply_tag_configuration.c/h`: Tag configuration management
- `Aply_nfc.c/h`: NFC application layer management
- `Aply_uwb_tx.c/h`: UWB transmission management
- `Aply_uwb_rx.c/h`: UWB reception management
- `def_config.h`: Configuration definitions
- `def_packet.h`: Packet structure definitions
- `def_pin.h`: Pin definitions
- `Func_TEIA_ROUTINES.c/h`: Core routines and GPIO management
- `Func_UART_LOG.c/h`: UART logging functions

### Api/
- `Api_uwb.c/h`: UWB communication API
- `Api_uwb_param.c`: UWB parameter management
- `Api_ble.c/h`: BLE communication API
- `Api_nfc.c/h`: NFC communication API
- `Api_motion.c/h`: Motion detection API
- `Api_Led.c/h`: LED control API
- `Api_battery.c/h`: Battery management API
- `Api_sleep.c/h`: Sleep management API
- `Api_sleep_peripheral.c/h`: Sleep peripheral management
- `Api_diagnostic.c/h`: System diagnostic API
- `Api_failsafe.c/h`: Failsafe management API
- `Driver/`: UWB driver layer (Drv_uwb.c/h, Drv_uwb_spi.c/h, etc.)

## 🎯 Current System Features

1. **State Machine Based**: UWB lifecycle managed by state machine
2. **Counter Based Scheduling**: Each function scheduled by counters
3. **Modular Structure**: API and Func layers separated by function
4. **Low Power Design**: Sleep mode and motion-based wakeup
5. **Multi Communication**: UWB, BLE, NFC support
6. **Battery Monitoring**: Real-time battery status display
7. **NFC Configuration**: Configuration management via NFC EEPROM
8. **Motion Sleep**: Intelligent sleep mode based on motion detection

## 🔄 Data Flow

```
Timer Tick → Counter Decrement → Flag Setting → Function Execution → UWB Transmission → Sleep → Repeat
```

This structure provides a modularized tag manager system with improved maintainability and functionality.
